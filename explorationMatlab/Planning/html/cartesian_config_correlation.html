
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>cartesian_config_correlation</title>
      <meta name="generator" content="MATLAB 7.6">
      <meta name="date" content="2008-07-17">
      <meta name="m-file" content="cartesian_config_correlation"><style>

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#1">cartesian_config_correlation</a></li>
               <li><a href="#2">Load Variables</a></li>
               <li><a href="#3">Go through all the 3 joints C-space discretely</a></li>
               <li><a href="#4">this will put all points in the one list so we can look at a historgram of it</a></li>
               <li><a href="#5">Now make one big list of the importance of each unique node</a></li>
            </ul>
         </div>
         <h2>cartesian_config_correlation<a name="1"></a></h2>
         <p>Description: This function/script goes through and determines the relationship between the cartesian workspace and the configuration
            space. So for each pose in C-Space which obstacles in workspace affect this pose. Both C-space and workspace are discretised
         </p><pre class="codeinput"><span class="comment">% function cartesian_config_correlation()</span>

close <span class="string">all</span>;
</pre><h2>Load Variables<a name="2"></a></h2><pre class="codeinput"><span class="keyword">global</span> r workspace optimise densoobj
qlimits=r.qlim;

<span class="comment">% how many times bigger than the max move angle size can we accept</span>
leaniancy=optimise.waterPPleaniancy;
<span class="comment">% Probability of animation of a pose with points</span>
animate=0.001;

<span class="comment">% Determine the points in workspace</span>
index=GetImpLevInfo(workspace.unknowncoords);
points=workspace.unknowncoords(index,:);

<span class="comment">% If there is anything</span>
<span class="keyword">if</span> animate&gt;0
    figure(1)
    camlight
    plotdenso(r,[0,0,0,0,0,0])
    hold <span class="string">on</span>;temphandle=plot3(points(:,1),points(:,2),points(:,3),<span class="string">'b.'</span>);
    axis <span class="string">equal</span>
    title(<span class="string">'All obstacle points in the workspace, jointly showing the robot arm in pose with all joints=0'</span>)
    view(3);pause(0.1);

<span class="keyword">end</span>

<span class="comment">% the number of discrete points in C-space on the first 3 joints</span>
matsize=floor((qlimits(1:3,2)-qlimits(1:3,1))./optimise.max_angle_for123'/leaniancy);

n = r.n;
rob_base = r.base;

<span class="comment">% Lookup the link pieces</span>
L = r.link;
<span class="keyword">for</span> piece=1:n
    linkvals(piece).val=[L{piece}.alpha L{piece}.A L{piece}.D L{piece}.offset];
<span class="keyword">end</span>

<span class="comment">% overall count</span>
totalpointsindex=0;
</pre><img vspace="5" hspace="5" src="cartesian_config_correlation_01.png"> <h2>Go through all the 3 joints C-space discretely<a name="3"></a></h2><pre class="codeinput"><span class="comment">%setup another figure</span>
figure(2); camlight; view(3); axis <span class="string">equal</span>;

<span class="keyword">for</span> i=1:matsize(1)
    <span class="keyword">for</span> j=1:matsize(2)
        <span class="keyword">for</span> k=1:matsize(3)
            [J1,J2,J3]=mapindextojoints(i,j,k,qlimits,matsize);
            t = rob_base;
            all_steps=[J1,J2,J3,0,0,0];
            <span class="comment">%check the soft limits</span>
            <span class="keyword">if</span> ~joint_softlimit_check(all_steps)
                depend(i,j,k).softlimit=1;
            <span class="keyword">else</span>
                depend(i,j,k).softlimit=0;
                indexincol=[];
                <span class="keyword">for</span> piece=1:n
                    t = t * linktransform_gp(linkvals(piece).val,(all_steps(piece)));
                    <span class="keyword">if</span> piece&gt;2 <span class="comment">% used to be &gt;1, should also be  &amp;&amp; ~=5 (since we don't care about the 5th joint (6thpeice)</span>
                        ellipse_vals=densoobj(piece+1).ellipse;
                        translated_points=[points(:,1)-t(1,4) points(:,2)-t(2,4) points(:,3)-t(3,4)]*t(1:3,1:3);
                        indexincol=[indexincol;<span class="keyword">...</span>
                            find(((translated_points(:,1)-ellipse_vals.center(1)).^2)/ellipse_vals.params(1)^2+<span class="keyword">...</span>
                                 ((translated_points(:,2)-ellipse_vals.center(2)).^2)/ellipse_vals.params(2)^2+<span class="keyword">...</span>
                                 ((translated_points(:,3)-ellipse_vals.center(3)).^2)/ellipse_vals.params(3)^2&lt;=1)];
                    <span class="keyword">end</span>
                <span class="keyword">end</span>
                <span class="keyword">if</span> animate&gt;rand();
                    <span class="keyword">try</span> delete(temphandle);<span class="keyword">end</span>
                    hold <span class="string">on</span>;temphandle=plot3(points(indexincol,1),points(indexincol,2),points(indexincol,3),<span class="string">'r.'</span>);
                    plotdenso(r,all_steps)
                    view(3)
                    title(<span class="string">'Workspace obstacles affecting this C-space position'</span>)
<span class="comment">%                     pause(0.3);</span>
                <span class="keyword">end</span>

                depend(i,j,k).pointsindex=unique(indexincol);
                totalpointsindex=totalpointsindex+size(depend(i,j,k).pointsindex,1);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="cartesian_config_correlation_02.png"> <img vspace="5" hspace="5" src="cartesian_config_correlation_03.png"> <h2>this will put all points in the one list so we can look at a historgram of it<a name="4"></a></h2><pre class="codeinput">biglist=zeros([totalpointsindex,1]);
currentcount=1;
<span class="keyword">for</span> i=1:matsize(1)
    <span class="keyword">for</span> j=1:matsize(2)
        <span class="keyword">for</span> k=1:matsize(3)
            sizecurrentset=size(depend(i,j,k).pointsindex,1);
            <span class="keyword">if</span> sizecurrentset&gt;0
                biglist(currentcount:currentcount+sizecurrentset-1,:)=depend(i,j,k).pointsindex;
                currentcount=currentcount+sizecurrentset;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% Show each of the nodes and their usage how they affect the C-space</span>
biglist=sortrows(biglist);
uniquevals=unique(biglist);
figure(3);
hist(biglist,size(uniquevals,1))
title(<span class="string">'The histogram of importance of workspace nodes based upon the number of C-space node they affect'</span>);
xlabel(<span class="string">'Index of obstacle points in workspace'</span>)
ylabel(<span class="string">'Importance, how many C-space nodes they affect'</span>)
</pre><img vspace="5" hspace="5" src="cartesian_config_correlation_04.png"> <h2>Now make one big list of the importance of each unique node<a name="5"></a></h2><pre class="codeinput">currentcount=1;
uniquebiglist=zeros([size(uniquevals,1),2]);
<span class="comment">%this need to be placed in so we have a value to stop on</span>
biglist(end+1)=inf;
<span class="comment">% Go through each of the unique index of workspace obstacles</span>
<span class="keyword">for</span> i=1:size(uniquevals,1)
    uniquebiglist(i,1)=uniquevals(i);
    uniquebiglist(i,2)=find(biglist(currentcount:end,:)~=uniquebiglist(i,1),1)-1;
    currentcount=currentcount+uniquebiglist(i,2);
<span class="keyword">end</span>
<span class="comment">%remove the stopper</span>
biglist=biglist(1:end-1);

figure(4);
<span class="comment">% plot these showing importance of each of the points in the workspace by</span>
<span class="comment">% how many C-space nodes they affect</span>
C=[uniquebiglist(:,2)/max(uniquebiglist(:,2))];
scatter3(points(uniquebiglist(:,1),1),points(uniquebiglist(:,1),2),points(uniquebiglist(:,1),3),C*50,C);
axis <span class="string">equal</span>
title(<span class="string">'Workspace of robot'</span>)
xlabel(<span class="string">'x'</span>)
ylabel(<span class="string">'y'</span>)
zlabel(<span class="string">'z'</span>)
</pre><img vspace="5" hspace="5" src="cartesian_config_correlation_05.png"> <p class="footer"><br>
            Published with MATLAB&reg; 7.6<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
%% cartesian_config_correlation
% Description: This function/script goes through and determines the
% relationship between the cartesian workspace and the configuration space.
% So for each pose in C-Space which obstacles in workspace affect this
% pose. Both C-space and workspace are discretised

% function cartesian_config_correlation()

close all;

%% Load Variables
global r workspace optimise densoobj
qlimits=r.qlim;

% how many times bigger than the max move angle size can we accept
leaniancy=optimise.waterPPleaniancy;
% Probability of animation of a pose with points
animate=0.001;

% Determine the points in workspace
index=GetImpLevInfo(workspace.unknowncoords);
points=workspace.unknowncoords(index,:);

% If there is anything 
if animate>0
    figure(1)
    camlight
    plotdenso(r,[0,0,0,0,0,0])
    hold on;temphandle=plot3(points(:,1),points(:,2),points(:,3),'b.');
    axis equal
    title('All obstacle points in the workspace, jointly showing the robot arm in pose with all joints=0')
    view(3);pause(0.1);

end

% the number of discrete points in C-space on the first 3 joints
matsize=floor((qlimits(1:3,2)-qlimits(1:3,1))./optimise.max_angle_for123'/leaniancy);

n = r.n;
rob_base = r.base;

% Lookup the link pieces
L = r.link;
for piece=1:n
    linkvals(piece).val=[L{piece}.alpha L{piece}.A L{piece}.D L{piece}.offset];
end

% overall count
totalpointsindex=0;

%% Go through all the 3 joints C-space discretely
%setup another figure
figure(2); camlight; view(3); axis equal;
    
for i=1:matsize(1)
    for j=1:matsize(2)
        for k=1:matsize(3)
            [J1,J2,J3]=mapindextojoints(i,j,k,qlimits,matsize);
            t = rob_base;
            all_steps=[J1,J2,J3,0,0,0];            
            %check the soft limits
            if ~joint_softlimit_check(all_steps)
                depend(i,j,k).softlimit=1;
            else
                depend(i,j,k).softlimit=0;
                indexincol=[];
                for piece=1:n        
                    t = t * linktransform_gp(linkvals(piece).val,(all_steps(piece)));
                    if piece>2 % used to be >1, should also be  && ~=5 (since we don't care about the 5th joint (6thpeice)
                        ellipse_vals=densoobj(piece+1).ellipse;
                        translated_points=[points(:,1)-t(1,4) points(:,2)-t(2,4) points(:,3)-t(3,4)]*t(1:3,1:3);
                        indexincol=[indexincol;...
                            find(((translated_points(:,1)-ellipse_vals.center(1)).^2)/ellipse_vals.params(1)^2+...
                                 ((translated_points(:,2)-ellipse_vals.center(2)).^2)/ellipse_vals.params(2)^2+...
                                 ((translated_points(:,3)-ellipse_vals.center(3)).^2)/ellipse_vals.params(3)^2<=1)];
                    end
                end
                if animate>rand();
                    try delete(temphandle);end
                    hold on;temphandle=plot3(points(indexincol,1),points(indexincol,2),points(indexincol,3),'r.');
                    plotdenso(r,all_steps)
                    view(3)
                    title('Workspace obstacles affecting this C-space position')
%                     pause(0.3);
                end
                                
                depend(i,j,k).pointsindex=unique(indexincol);
                totalpointsindex=totalpointsindex+size(depend(i,j,k).pointsindex,1);
            end
        end
    end
end

%% this will put all points in the one list so we can look at a historgram of it
biglist=zeros([totalpointsindex,1]);
currentcount=1;
for i=1:matsize(1)
    for j=1:matsize(2)
        for k=1:matsize(3)
            sizecurrentset=size(depend(i,j,k).pointsindex,1);
            if sizecurrentset>0
                biglist(currentcount:currentcount+sizecurrentset-1,:)=depend(i,j,k).pointsindex;
                currentcount=currentcount+sizecurrentset;
            end
        end
    end
end
% Show each of the nodes and their usage how they affect the C-space
biglist=sortrows(biglist);
uniquevals=unique(biglist);
figure(3);
hist(biglist,size(uniquevals,1))
title('The histogram of importance of workspace nodes based upon the number of C-space node they affect');
xlabel('Index of obstacle points in workspace')
ylabel('Importance, how many C-space nodes they affect')

%% Now make one big list of the importance of each unique node
currentcount=1;
uniquebiglist=zeros([size(uniquevals,1),2]);
%this need to be placed in so we have a value to stop on
biglist(end+1)=inf;
% Go through each of the unique index of workspace obstacles
for i=1:size(uniquevals,1)
    uniquebiglist(i,1)=uniquevals(i);
    uniquebiglist(i,2)=find(biglist(currentcount:end,:)~=uniquebiglist(i,1),1)-1;
    currentcount=currentcount+uniquebiglist(i,2);
end
%remove the stopper
biglist=biglist(1:end-1);

figure(4);
% plot these showing importance of each of the points in the workspace by
% how many C-space nodes they affect
C=[uniquebiglist(:,2)/max(uniquebiglist(:,2))];
scatter3(points(uniquebiglist(:,1),1),points(uniquebiglist(:,1),2),points(uniquebiglist(:,1),3),C*50,C);    
axis equal
title('Workspace of robot')
xlabel('x')
ylabel('y')
zlabel('z')

    
    
##### SOURCE END #####
-->
   </body>
</html>