
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>use_real_robot_SCAN</title>
      <meta name="generator" content="MATLAB 7.4">
      <meta name="date" content="2007-10-05">
      <meta name="m-file" content="use_real_robot_SCAN"><style>

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h1>use_real_robot_SCAN</h1>
         <introduction>
            <p><b>Description:</b>  This is called to do the actual scan and is a way to modulate the scanning routine. Simply input the degrees that are to
               be scanned Q must be globally defined, scan width should be globally defined
            </p>
         </introduction>
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#1">Function Call</a></li>
               <li><a href="#2">Variables:  Declarations and checks</a></li>
               <li><a href="#3">Check view and make scan go in correct direction</a></li>
               <li><a href="#4">Start Scanning/robot communication</a></li>
               <li><a href="#5">Wait till complete</a></li>
               <li><a href="#6">Check validity</a></li>
               <li><a href="#7">FUNCTION: Releases the scanner and reset the speed to correct move speed</a></li>
            </ul>
         </div>
         <h2>Function Call<a name="1"></a></h2>
         <p><b>Inputs:</b></p>
         <p><i>deg2scan</i> (double) degrees - the number of degrees to tilt the scan through
         </p>
         <p><b>Returns:</b> NULL
         </p><pre class="codeinput"><span class="keyword">function</span> use_real_robot_SCAN(deg2scan)
</pre><h2>Variables:  Declarations and checks<a name="2"></a></h2><pre class="codeinput"><span class="comment">%THIS CLEARS GLOBAL VARS USED IN SCANS SO THEY DON'T BUILD UP</span>
display(<span class="string">'Clearing all global scan variables before starting a new scan'</span>);
clear <span class="string">global</span> <span class="string">PoseData</span> <span class="string">RangeData</span> <span class="string">IntensityData</span> <span class="string">PointData</span>;

<span class="keyword">global</span> scan Q PointData IntensityData robot_maxreach robmap_h;

<span class="keyword">if</span> size(Q,2)~=6
    error(<span class="string">'Q - Joints have not been defined properly, should be a global'</span>);
<span class="keyword">end</span>

tempQ=Q*180/pi;
</pre><h2>Check view and make scan go in correct direction<a name="3"></a></h2><pre class="codeinput"><span class="keyword">if</span> nargin==0
    <span class="keyword">if</span> scan.chosenview(3)&gt;0
        tilt_scan_range=round(-(Q(5)-scan.alpha)*180/pi);
    <span class="keyword">else</span>
        tilt_scan_range=round(-(Q(5)+scan.alpha)*180/pi);
    <span class="keyword">end</span>
<span class="keyword">else</span>
    tilt_scan_range=deg2scan;
<span class="keyword">end</span>

<span class="comment">%uiwait(msgbox(strcat('The robot is currently at:', num2str(tempQ),' and is planning to scan through :',num2str(tilt_scan_range),'. Please get ready to push EMERGENCY STOP')));</span>
</pre><h2>Start Scanning/robot communication<a name="4"></a></h2><pre class="codeinput">attemptingscan=4; <span class="comment">%used to set how many times we try before giving up</span>

<span class="keyword">while</span> attemptingscan
    <span class="comment">%give it an initial pose for base position)</span>
    robscan_h=robmap_h.ScannerCommand(eye(4));

    robscan_h.Type=<span class="string">'TiltingRangeScan'</span>;
    robscan_h.TiltSpeed=robot_maxreach.scan_speed;

    <span class="comment">%robscan_h.Mode='RangeOnly';</span>
    robscan_h.Mode=<span class="string">'RangeAndAveragedIntensity'</span>;

    <span class="comment">%this is 120' either side so 2* 120</span>
    robscan_h.width=2*scan.theta*180/pi;

    <span class="comment">%display scan details</span>
    display(strcat(<span class="string">'Current Scan mode is: '</span>,robscan_h.Mode,<span class="keyword">...</span>
        <span class="string">'. Total width is: '</span>,num2str(robscan_h.width),<span class="keyword">...</span>
        <span class="string">'. Scanning through: '</span>, num2str(tilt_scan_range)));

    <span class="comment">%tilt through desired scan range in the negative direction so laser is safe (might be confusing)</span>
    pause(0.05);
    robscan_h.Start(tilt_scan_range);

    pause(0.2);

    <span class="comment">%if not started their must be a problem or if no data has started to be returned</span>
    <span class="keyword">if</span>(robscan_h.Started==0 &amp;&amp; get(robscan_h,<span class="string">'Completed'</span>)==0)
        release_scanner(robscan_h);

        <span class="keyword">if</span> attemptingscan&lt;=1 <span class="comment">% it should break out here before getting through the while loop</span>
            error(<span class="string">'Scanner hasnt started yet there is a problem with the laser... Giving up'</span>);
        <span class="keyword">else</span>
            display(<span class="string">'Problem in this try - retrying'</span>);
            attemptingscan=attemptingscan-1;
            pause(0.2);
        <span class="keyword">end</span>
    <span class="keyword">elseif</span> isempty(PointData)
        display(<span class="string">'Waiting for laser to complete before retrying'</span>);
        <span class="keyword">while</span> get(robscan_h,<span class="string">'Completed'</span>)==0
            pause(0.5);display(<span class="string">'.'</span>);
            <span class="comment">%checks that there still really is no data coming back</span>
            <span class="keyword">if</span> ~isempty(PointData); attemptingscan=0; <span class="keyword">break</span>; <span class="keyword">end</span>
        <span class="keyword">end</span>
        release_scanner(robscan_h);
        error(<span class="string">'No Data coming back ... Giving up'</span>);
    <span class="keyword">else</span>
        <span class="comment">%it has started so we have no need to retry this breaks out of loop</span>
        attemptingscan=0;
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>Wait till complete<a name="5"></a></h2><pre class="codeinput">temp_counter=70; <span class="comment">%simply keep on checking arbitary time if finished until actually finished</span>
<span class="keyword">while</span> get(robscan_h,<span class="string">'Completed'</span>)==0 || isempty(PointData)
    <span class="comment">%display('waiting in scan');</span>
    pause(0.5);
     <span class="keyword">if</span> temp_counter&lt;=0
         response=input(strcat(<span class="string">'Completed='</span>,num2str(get(robscan_h,<span class="string">'Completed'</span>)),<span class="keyword">...</span>
                             <span class="string">', PointData isempty='</span>,num2str(isempty(PointData)),<span class="keyword">...</span>
                             <span class="string">'. So we are waiting in scan: type (0) to quit, (1) for keyboard or anything else to continue\n'</span>));
        <span class="keyword">if</span> response==0
            release_scanner(robscan_h);
            error(<span class="string">'something wrong with the laser scanning process'</span>);
        <span class="keyword">elseif</span> response==1
            keyboard
        <span class="keyword">end</span>
        temp_counter=10;
    <span class="keyword">else</span>
        temp_counter=temp_counter-1;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">%need some way to save this to a variable that doesn't get deleted</span>
scan.PointData=PointData;
scan.IntensityData=IntensityData;

release_scanner(robscan_h);
</pre><h2>Check validity<a name="6"></a></h2><pre class="codeinput"><span class="keyword">if</span> size(PointData,1)==0 &amp;&amp; tilt_scan_range~=0
    error(<span class="string">'Scanner did not return any data'</span>)
<span class="keyword">end</span>
</pre><h2>FUNCTION: Releases the scanner and reset the speed to correct move speed<a name="7"></a></h2><pre class="codeinput"><span class="keyword">function</span> release_scanner(robscan_h)
<span class="keyword">global</span> robot_maxreach
pause(0.1);
robscan_h.TiltSpeed=robot_maxreach.move_speed;
robscan_h.Start(0);pause(0.1);
robscan_h.release;
pause(0.1);
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.4<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
%% use_real_robot_SCAN
%
% *Description:*  This is called to do the actual scan and is a way to
% modulate the scanning routine. Simply input the degrees that are to be
% scanned Q must be globally defined, scan width should be globally defined

%% Function Call
%
% *Inputs:* 
%
% _deg2scan_ (double) degrees - the number of degrees to tilt the scan
% through
%
% *Returns:* NULL

function use_real_robot_SCAN(deg2scan)

%% Variables:  Declarations and checks
%THIS CLEARS GLOBAL VARS USED IN SCANS SO THEY DON'T BUILD UP
display('Clearing all global scan variables before starting a new scan');
clear global PoseData RangeData IntensityData PointData;

global scan Q PointData IntensityData robot_maxreach robmap_h;

if size(Q,2)~=6
    error('Q - Joints have not been defined properly, should be a global');
end

tempQ=Q*180/pi;

%% Check view and make scan go in correct direction
if nargin==0
    if scan.chosenview(3)>0
        tilt_scan_range=round(-(Q(5)-scan.alpha)*180/pi);
    else
        tilt_scan_range=round(-(Q(5)+scan.alpha)*180/pi);
    end
else
    tilt_scan_range=deg2scan;
end

%uiwait(msgbox(strcat('The robot is currently at:', num2str(tempQ),' and is planning to scan through :',num2str(tilt_scan_range),'. Please get ready to push EMERGENCY STOP')));


%% Start Scanning/robot communication
attemptingscan=4; %used to set how many times we try before giving up

while attemptingscan
    %give it an initial pose for base position)
    robscan_h=robmap_h.ScannerCommand(eye(4));
    
    robscan_h.Type='TiltingRangeScan';
    robscan_h.TiltSpeed=robot_maxreach.scan_speed;
    
    %robscan_h.Mode='RangeOnly';
    robscan_h.Mode='RangeAndAveragedIntensity';        
    
    %this is 120' either side so 2* 120
    robscan_h.width=2*scan.theta*180/pi;

    %display scan details
    display(strcat('Current Scan mode is: ',robscan_h.Mode,...
        '. Total width is: ',num2str(robscan_h.width),...
        '. Scanning through: ', num2str(tilt_scan_range)));

    %tilt through desired scan range in the negative direction so laser is safe (might be confusing)
    pause(0.05);
    robscan_h.Start(tilt_scan_range);
    
    pause(0.2);
    
    %if not started their must be a problem or if no data has started to be returned
    if(robscan_h.Started==0 && get(robscan_h,'Completed')==0)   
        release_scanner(robscan_h);

        if attemptingscan<=1 % it should break out here before getting through the while loop
            error('Scanner hasnt started yet there is a problem with the laser... Giving up');
        else
            display('Problem in this try - retrying');                           
            attemptingscan=attemptingscan-1;
            pause(0.2);
        end
    elseif isempty(PointData)
        display('Waiting for laser to complete before retrying');
        while get(robscan_h,'Completed')==0
            pause(0.5);display('.');
            %checks that there still really is no data coming back
            if ~isempty(PointData); attemptingscan=0; break; end
        end
        release_scanner(robscan_h);
        error('No Data coming back ... Giving up');             
    else
        %it has started so we have no need to retry this breaks out of loop
        attemptingscan=0;
    end
end
    
%% Wait till complete
temp_counter=70; %simply keep on checking arbitary time if finished until actually finished
while get(robscan_h,'Completed')==0 || isempty(PointData)
    %display('waiting in scan');
    pause(0.5);
     if temp_counter<=0
         response=input(strcat('Completed=',num2str(get(robscan_h,'Completed')),...
                             ', PointData isempty=',num2str(isempty(PointData)),...
                             '. So we are waiting in scan: type (0) to quit, (1) for keyboard or anything else to continue\n'));
        if response==0
            release_scanner(robscan_h);
            error('something wrong with the laser scanning process');
        elseif response==1
            keyboard
        end
        temp_counter=10;
    else
        temp_counter=temp_counter-1;
    end
end

%need some way to save this to a variable that doesn't get deleted
scan.PointData=PointData;
scan.IntensityData=IntensityData;

release_scanner(robscan_h);

%% Check validity
if size(PointData,1)==0 && tilt_scan_range~=0
    error('Scanner did not return any data')
end

%% FUNCTION: Releases the scanner and reset the speed to correct move speed
function release_scanner(robscan_h)
global robot_maxreach
pause(0.1);    
robscan_h.TiltSpeed=robot_maxreach.move_speed;
robscan_h.Start(0);pause(0.1);
robscan_h.release;
pause(0.1);
##### SOURCE END #####
-->
   </body>
</html>