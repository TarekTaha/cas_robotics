
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>demopath</title>
      <meta name="generator" content="MATLAB 7.4">
      <meta name="date" content="2008-01-14">
      <meta name="m-file" content="demopath_new"><style>

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h1>demopath</h1>
         <introduction>
            <p><b>Description:</b>  This function is sent the steps of a path and then this function will go through each step and show the path. There is also
               the option not to send in steps and it will load path_data.mat and then gather data about the movement of joints around the
               current step. This can be used to produce an image of the configuration space
            </p>
         </introduction>
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#1">Function Call</a></li>
               <li><a href="#2">Variables</a></li>
               <li><a href="#3">Setup the figure (if required)</a></li>
               <li><a href="#4">Go through each path</a></li>
               <li><a href="#5">If we wish to save the results</a></li>
            </ul>
         </div>
         <h2>Function Call<a name="1"></a></h2>
         <p><b>Inputs:</b></p>
         <p><i>all_steps</i> (6*m double) these are the joint configs radians
         </p>
         <p><b>Returns:</b> NULL
         </p><pre class="codeinput"><span class="keyword">function</span> demopath(all_steps)
</pre><h2>Variables<a name="2"></a></h2><pre class="codeinput"><span class="keyword">global</span> r Q densoobj workspace optimise

<span class="keyword">if</span> size(r,1)&lt;1
    error(<span class="string">'robot has not been setup'</span>)
<span class="keyword">end</span>

<span class="comment">%setup path data and obsticle data</span>
<span class="keyword">if</span> nargin==0
    <span class="comment">%make a test case and then act these out</span>
    <span class="comment">%testpathplanner(30);</span>
    load <span class="string">pathdata.mat</span>;
    DISPON=false;
    <span class="comment">%to check the differentials</span>
    checkstepsize=true;
      overalltotalmovement=0;
      overallabsstart_end_diff=0;

    diffrad2check=optimise.max_angle_for123;
    showOBpoints=false;;

    points=workspace.indexedobsticles;
    check_all_Js=false;
    jointlimits=r.qlim;
    allFFresults.joint1_data=[];
    allFFresults.joint2_data=[];
    allFFresults.joint3_data=[];
    allFFresults.joint4_data=[];
    allFFresults.joint5_data=[];
    allFFresults.joint6_data=[];
    angle_res=0.01; <span class="comment">%radians</span>
    n = r.n;
    L = r.link;
<span class="keyword">else</span> <span class="comment">%we are just demoing the path that has been passed</span>
    pathdata(1).all_steps=all_steps;
    DISPON=true;
    points=workspace.indexedobsticles;
    check_all_Js=false;
    checkstepsize=false;
    showOBpoints=false;
<span class="keyword">end</span>
</pre><h2>Setup the figure (if required)<a name="3"></a></h2><pre class="codeinput"><span class="keyword">if</span> DISPON
    <span class="comment">%fig=figure(2);</span>
    <span class="keyword">if</span> size(points,1)&gt;0 &amp;&amp; showOBpoints
        plot3(points(:,1),points(:,2),points(:,3),<span class="string">'marker'</span>,<span class="string">'.'</span>,<span class="string">'Color'</span>,[.2,.2,.1],<span class="string">'linestyle'</span>,<span class="string">'none'</span>);
    <span class="keyword">end</span>
    view(3);axis([-1 1 -1 1 0 1.5]);
<span class="comment">%     colordef white;</span>
<span class="comment">%     grid on;</span>
    hold <span class="string">on</span>;
<span class="keyword">end</span>
</pre><h2>Go through each path<a name="4"></a></h2><pre class="codeinput"><span class="keyword">for</span> current_path=1:size(pathdata,2)
    <span class="keyword">if</span> current_path&gt;2 &amp;&amp; DISPON; display(strcat(<span class="string">'Now working on path num:'</span>,num2str(current_path)));<span class="keyword">end</span>;
    <span class="keyword">if</span> checkstepsize==true
        all_stepsdiff=diff(pathdata(current_path).all_steps);
        <span class="keyword">if</span> ~isempty(find(all_stepsdiff(:,1)&gt;diffrad2check(1)|<span class="keyword">...</span>
                         all_stepsdiff(:,2)&gt;diffrad2check(2)|<span class="keyword">...</span>
                         all_stepsdiff(:,3)&gt;diffrad2check(3),1))
            display(<span class="string">'There is a problem with this path - exceeding min J1-J3 step limits'</span>);
        <span class="keyword">end</span>
        <span class="keyword">if</span> ~isempty(find(all_stepsdiff(:,4)&gt;20*pi/180,1)) &amp;&amp; DISPON
            display(<span class="string">'joints 4has moved more than 20 deg in a step'</span>);
        <span class="keyword">end</span>
        <span class="keyword">if</span> ~isempty(find(all_stepsdiff(:,5)&gt;30*pi/180,1)) &amp;&amp; DISPON
            display(<span class="string">'joints 5 has moved more than 30 deg in a step'</span>);
        <span class="keyword">end</span>
        <span class="keyword">if</span> ~isempty(find(all_stepsdiff(:,4)&gt;30*pi/180,1)) &amp;&amp; DISPON
            display(<span class="string">'joints 6 has moved more than 30 deg in a step'</span>);
        <span class="keyword">end</span>
        <span class="comment">%work out the total actual movement for the path as compared to</span>
        <span class="comment">%direct path</span>
        totalmovement=[sum(abs(all_stepsdiff(:,1))),sum(abs(all_stepsdiff(:,2))),sum(abs(all_stepsdiff(:,3)))];
        absstart_end_diff=abs(pathdata(current_path).all_steps(1,1:3)-pathdata(current_path).all_steps(end,1:3));
        diffaverage(current_path,:)=totalmovement./absstart_end_diff;
        overalltotalmovement=overalltotalmovement+totalmovement;
        overallabsstart_end_diff=overallabsstart_end_diff+absstart_end_diff;
    <span class="keyword">end</span>


    <span class="comment">% Show ellispes if required</span>
    <span class="keyword">if</span> rand&gt;1 show_ellipses=true;
    <span class="keyword">else</span> show_ellipses=false;
    <span class="keyword">end</span>

    <span class="comment">% Determine the start and end point</span>
    start_t=fkine(r,pathdata(current_path).all_steps(1,:));
    end_t=fkine(r,pathdata(current_path).all_steps(end,:));
    pointsH=plot3([start_t(1,4) end_t(1,4)],[start_t(2,4) end_t(2,4)],[start_t(3,4) end_t(3,4)],<span class="string">'b'</span>);

    <span class="comment">%go through and actually animate each step of this particular path</span>
    <span class="keyword">for</span> current_step=1:size(pathdata(current_path).all_steps,1)
        nextQ=pathdata(current_path).all_steps(current_step,:);
        <span class="keyword">if</span> DISPON
            plotdenso(r, nextQ, show_ellipses, show_ellipses);

            <span class="comment">%work out where the end effector is</span>
            t=fkine(r,nextQ);
            <span class="keyword">if</span> current_step==1; prev_t=start_t; <span class="keyword">end</span>;

            temppointsH=plot3([prev_t(1,4) t(1,4)],[prev_t(2,4) t(2,4)],[prev_t(3,4) t(3,4)],<span class="string">'Color'</span>,[1 0 0]);
            prev_t=t;
            <span class="comment">%add plot handle to the stack so that it can be deleted</span>
            pointsH=[pointsH;temppointsH];

            drawnow;
        <span class="keyword">end</span>

        <span class="comment">%it will go through an check either side (completely) of the</span>
        <span class="comment">%current joint to see where collisions could have occured</span>
        <span class="keyword">if</span> check_all_Js
            <span class="keyword">for</span> current_joint=1:3
                tempresult=[];
                tempnextQ=nextQ;
                <span class="keyword">for</span> current_angle=jointlimits(current_joint,1):angle_res:jointlimits(current_joint,2)
                    tempnextQ(current_joint)=current_angle;

                    t = r.base;
                    FF_OK=1;<span class="comment">%force field ok</span>
                    <span class="keyword">for</span> piece=1:n
                        t = t * L{piece}(tempnextQ(piece));
                        <span class="keyword">if</span> ~check_FF(t,densoobj(piece+1).ellipse,points)
                            FF_OK=0;
                            <span class="keyword">break</span>
                        <span class="keyword">end</span>
                    <span class="keyword">end</span>
                    tempresult=[tempresult;FF_OK];
                <span class="keyword">end</span>

                <span class="comment">%change the value where the current angleis</span>
                <span class="keyword">try</span> tempresult(round((-jointlimits(current_joint,1)+nextQ(current_joint))/angle_res))=0.5;
                <span class="keyword">catch</span> <span class="keyword">if</span> round((-jointlimits(current_joint,1)+nextQ(current_joint))/angle_res)&lt;=0
                        tempresult(1)=0.5;
                    <span class="keyword">else</span>
                        tempresult(end)=0.5;
                    <span class="keyword">end</span>
                <span class="keyword">end</span>

                <span class="comment">%add the data about all the joints (if changes) at the</span>
                <span class="comment">%current step to the overall data</span>
                <span class="keyword">if</span> current_joint==1
                    allFFresults.joint1_data=[allFFresults.joint1_data,tempresult];
                <span class="keyword">elseif</span> current_joint==2
                    allFFresults.joint2_data=[allFFresults.joint2_data,tempresult];
                <span class="keyword">elseif</span> current_joint==3
                    allFFresults.joint3_data=[allFFresults.joint3_data,tempresult];
                <span class="keyword">elseif</span> current_joint==4
                    allFFresults.joint4_data=[allFFresults.joint4_data,tempresult];
                <span class="keyword">elseif</span> current_joint==5
                    allFFresults.joint5_data=[allFFresults.joint5_data,tempresult];
                <span class="keyword">elseif</span> current_joint==6
                    allFFresults.joint6_data=[allFFresults.joint6_data,tempresult];
                <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="keyword">if</span> DISPON
        axis([-1 1 -1 1 0 1.5]);
<span class="comment">%         grid on;</span>
<span class="comment">%         rotate3d on;</span>
        <span class="comment">%pause(3)</span>
<span class="comment">%         rotate3d off;</span>
        <span class="comment">%print('-dpng', sprintf('%s_%03.0f_%03.0f.png', 'demopath',current_path, current_step));</span>

    <span class="keyword">end</span>

    <span class="comment">%try and delete the intermediate points of movement</span>
    <span class="keyword">for</span> current_h=1:size(pointsH,1)
        <span class="keyword">try</span> delete(pointsH(current_h)); <span class="keyword">end</span>;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">%if we want to show results of the checks on the stepsize</span>
<span class="keyword">if</span> checkstepsize==true
    display([<span class="string">'Ave(permove) Act Q move/hypothetical dir j move:[J1-&gt;3]=['</span>,<span class="keyword">...</span>
        num2str(sum(diffaverage(:,1))/size(diffaverage(:,1),1)),<span class="string">','</span>,<span class="keyword">...</span>
        num2str(sum(diffaverage(:,2))/size(diffaverage(:,2),1)),<span class="string">','</span>,<span class="keyword">...</span>
        num2str(sum(diffaverage(:,3))/size(diffaverage(:,3),1)),<span class="string">']'</span>]);
    display([<span class="string">'Total actMove/endjsdiff (ratio): [J1-&gt;3]=['</span>,<span class="keyword">...</span>
        num2str(overalltotalmovement./overallabsstart_end_diff)]);
<span class="keyword">end</span>
</pre><h2>If we wish to save the results<a name="5"></a></h2><pre class="codeinput"><span class="keyword">if</span> check_all_Js
    <span class="comment">%keyboard</span>
    save(<span class="string">'allFFresults.mat'</span>,<span class="string">'allFFresults'</span>);
<span class="keyword">end</span>
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.4<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
%% demopath
%
% *Description:*  This function is sent the steps of a path and then this
% function will go through each step and show the path. There is also the
% option not to send in steps and it will load path_data.mat and then
% gather data about the movement of joints around the current step. This
% can be used to produce an image of the configuration space


%% Function Call
% 
% *Inputs:* 
%
% _all_steps_ (6*m double) these are the joint configs radians
%
% *Returns:* NULL

function demopath(all_steps)

%% Variables
global r Q densoobj workspace optimise

if size(r,1)<1
    error('robot has not been setup')
end

%setup path data and obsticle data
if nargin==0
    %make a test case and then act these out
    %testpathplanner(30);
    load pathdata.mat;
    DISPON=false;
    %to check the differentials
    checkstepsize=true; 
      overalltotalmovement=0;
      overallabsstart_end_diff=0;
      
    diffrad2check=optimise.max_angle_for123;
    showOBpoints=false;;
    
    points=workspace.indexedobsticles;
    check_all_Js=false;
    jointlimits=r.qlim;
    allFFresults.joint1_data=[];
    allFFresults.joint2_data=[];
    allFFresults.joint3_data=[];
    allFFresults.joint4_data=[];
    allFFresults.joint5_data=[];
    allFFresults.joint6_data=[];
    angle_res=0.01; %radians
    n = r.n;
    L = r.link;
else %we are just demoing the path that has been passed
    pathdata(1).all_steps=all_steps;
    DISPON=true;
    points=workspace.indexedobsticles;
    check_all_Js=false;
    checkstepsize=false;
    showOBpoints=false;
end

%% Setup the figure (if required)
if DISPON
    %fig=figure(2); 
    if size(points,1)>0 && showOBpoints
        plot3(points(:,1),points(:,2),points(:,3),'marker','.','Color',[.2,.2,.1],'linestyle','none'); 
    end        
    view(3);axis([-1 1 -1 1 0 1.5]);
%     colordef white;
%     grid on;
    hold on;
end


%% Go through each path
for current_path=1:size(pathdata,2)
    if current_path>2 && DISPON; display(strcat('Now working on path num:',num2str(current_path)));end;
    if checkstepsize==true
        all_stepsdiff=diff(pathdata(current_path).all_steps);
        if ~isempty(find(all_stepsdiff(:,1)>diffrad2check(1)|...
                         all_stepsdiff(:,2)>diffrad2check(2)|...
                         all_stepsdiff(:,3)>diffrad2check(3),1))
            display('There is a problem with this path - exceeding min J1-J3 step limits');
        end
        if ~isempty(find(all_stepsdiff(:,4)>20*pi/180,1)) && DISPON
            display('joints 4has moved more than 20 deg in a step');
        end
        if ~isempty(find(all_stepsdiff(:,5)>30*pi/180,1)) && DISPON
            display('joints 5 has moved more than 30 deg in a step');
        end
        if ~isempty(find(all_stepsdiff(:,4)>30*pi/180,1)) && DISPON
            display('joints 6 has moved more than 30 deg in a step');
        end
        %work out the total actual movement for the path as compared to
        %direct path
        totalmovement=[sum(abs(all_stepsdiff(:,1))),sum(abs(all_stepsdiff(:,2))),sum(abs(all_stepsdiff(:,3)))];
        absstart_end_diff=abs(pathdata(current_path).all_steps(1,1:3)-pathdata(current_path).all_steps(end,1:3));
        diffaverage(current_path,:)=totalmovement./absstart_end_diff;
        overalltotalmovement=overalltotalmovement+totalmovement;
        overallabsstart_end_diff=overallabsstart_end_diff+absstart_end_diff;
    end


    % Show ellispes if required
    if rand>1 show_ellipses=true;
    else show_ellipses=false;        
    end
    
    % Determine the start and end point
    start_t=fkine(r,pathdata(current_path).all_steps(1,:));
    end_t=fkine(r,pathdata(current_path).all_steps(end,:));
    pointsH=plot3([start_t(1,4) end_t(1,4)],[start_t(2,4) end_t(2,4)],[start_t(3,4) end_t(3,4)],'b');
    
    %go through and actually animate each step of this particular path
    for current_step=1:size(pathdata(current_path).all_steps,1)        
        nextQ=pathdata(current_path).all_steps(current_step,:);        
        if DISPON
            plotdenso(r, nextQ, show_ellipses, show_ellipses);        
        
            %work out where the end effector is
            t=fkine(r,nextQ);
            if current_step==1; prev_t=start_t; end;

            temppointsH=plot3([prev_t(1,4) t(1,4)],[prev_t(2,4) t(2,4)],[prev_t(3,4) t(3,4)],'Color',[1 0 0]);
            prev_t=t;
            %add plot handle to the stack so that it can be deleted
            pointsH=[pointsH;temppointsH];        

            drawnow;        
        end
        
        %it will go through an check either side (completely) of the
        %current joint to see where collisions could have occured
        if check_all_Js
            for current_joint=1:3
                tempresult=[];
                tempnextQ=nextQ;
                for current_angle=jointlimits(current_joint,1):angle_res:jointlimits(current_joint,2)
                    tempnextQ(current_joint)=current_angle;

                    t = r.base;
                    FF_OK=1;%force field ok
                    for piece=1:n
                        t = t * L{piece}(tempnextQ(piece));    
                        if ~check_FF(t,densoobj(piece+1).ellipse,points)
                            FF_OK=0;
                            break
                        end
                    end
                    tempresult=[tempresult;FF_OK];                   
                end

                %change the value where the current angleis
                try tempresult(round((-jointlimits(current_joint,1)+nextQ(current_joint))/angle_res))=0.5;
                catch if round((-jointlimits(current_joint,1)+nextQ(current_joint))/angle_res)<=0
                        tempresult(1)=0.5;
                    else
                        tempresult(end)=0.5;
                    end
                end
                
                %add the data about all the joints (if changes) at the
                %current step to the overall data
                if current_joint==1
                    allFFresults.joint1_data=[allFFresults.joint1_data,tempresult];
                elseif current_joint==2 
                    allFFresults.joint2_data=[allFFresults.joint2_data,tempresult];
                elseif current_joint==3
                    allFFresults.joint3_data=[allFFresults.joint3_data,tempresult];                
                elseif current_joint==4
                    allFFresults.joint4_data=[allFFresults.joint4_data,tempresult];                
                elseif current_joint==5
                    allFFresults.joint5_data=[allFFresults.joint5_data,tempresult];                
                elseif current_joint==6
                    allFFresults.joint6_data=[allFFresults.joint6_data,tempresult];                
                end      
            end
        end
    end    
    
    if DISPON
        axis([-1 1 -1 1 0 1.5]);
%         grid on;
%         rotate3d on;
        %pause(3)
%         rotate3d off;
        %print('-dpng', sprintf('%s_%03.0f_%03.0f.png', 'demopath',current_path, current_step));
        
    end
    
    %try and delete the intermediate points of movement
    for current_h=1:size(pointsH,1)
        try delete(pointsH(current_h)); end;
    end
end

%if we want to show results of the checks on the stepsize
if checkstepsize==true
    display(['Ave(permove) Act Q move/hypothetical dir j move:[J1->3]=[',...
        num2str(sum(diffaverage(:,1))/size(diffaverage(:,1),1)),',',...
        num2str(sum(diffaverage(:,2))/size(diffaverage(:,2),1)),',',...
        num2str(sum(diffaverage(:,3))/size(diffaverage(:,3),1)),']']);
    display(['Total actMove/endjsdiff (ratio): [J1->3]=[',...
        num2str(overalltotalmovement./overallabsstart_end_diff)]);
end

%% If we wish to save the results
if check_all_Js
    %keyboard
    save('allFFresults.mat','allFFresults');
end

##### SOURCE END #####
-->
   </body>
</html>