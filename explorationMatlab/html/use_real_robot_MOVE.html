
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>use_real_robot_MOVE</title>
      <meta name="generator" content="MATLAB 7.4">
      <meta name="date" content="2008-01-14">
      <meta name="m-file" content="use_real_robot_MOVE"><style>

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content">
         <h1>use_real_robot_MOVE</h1>
         <introduction>
            <p><b>Description:</b>  This can be called by anywhere and is a way to modulae to the moving routine. It starts a robot moving object global Q -
               joints must be defined Note: Lots of magic numbers in this function but most are arbitory pauses for coms reasons or for error
               catching reasons, the other numbers are soft motion checks for the arm but are not really needed since specific functions
               do checks during path planning
            </p>
         </introduction>
         <h2>Contents</h2>
         <div>
            <ul>
               <li><a href="#1">Function Call</a></li>
               <li><a href="#2">Variables</a></li>
               <li><a href="#3">Check that no steps exceed soft limits</a></li>
               <li><a href="#4">Setup robot movement object</a></li>
               <li><a href="#5">Check if all joints are the same as what we want them to be within 1degree</a></li>
               <li><a href="#6">Move to an absolute joint reference if there is no path, otherwise</a></li>
               <li><a href="#7">Drive the arm through the sequence of poses in all_steps</a></li>
               <li><a href="#8">FUNCTION release the robot object</a></li>
            </ul>
         </div>
         <h2>Function Call<a name="1"></a></h2>
         <p><b>Inputs:</b></p>
         <p><i>all_steps</i> (many*6 double) radians the steps that the arm must move through on its path
         </p>
         <p><b>Returns:</b> NULL
         </p><pre class="codeinput"><span class="keyword">function</span> use_real_robot_MOVE(all_steps)
</pre><h2>Variables<a name="2"></a></h2><pre class="codeinput"><span class="keyword">global</span> Q robot_maxreach
<span class="keyword">if</span> size(Q,2)~=6
    error(<span class="string">'Q - Joints have not been defined properly, should be a global'</span>);
<span class="keyword">end</span>

<span class="keyword">if</span> nargin==0
    <span class="comment">%No path has been passed in</span>
    all_steps=[];
    tempQ=Q*180/pi;
<span class="keyword">else</span>
    tempQ=all_steps(end,:)*180/pi;
<span class="keyword">end</span>
</pre><h2>Check that no steps exceed soft limits<a name="3"></a></h2><pre class="codeinput"><span class="keyword">if</span> ~joint_softlimit_check(all_steps)
    display(<span class="string">'there is a possible bad position in the joint steps, this shouldnt be planned, giving you control'</span>)
    keyboard
<span class="keyword">end</span>
</pre><h2>Setup robot movement object<a name="4"></a></h2><pre class="codeinput">rob_h=actxserver(<span class="string">'EyeInHand.DensoCommand'</span>);
<span class="comment">%make sure comms up are up to speed</span>
waitcounter=0;
<span class="keyword">while</span> size(rob_h.JointState,2)~=6
    pause(0.2);
    <span class="keyword">if</span> waitcounter&gt;25 <span class="comment">%5 secs</span>
        error(<span class="string">'There is some problem with controller:m , make sure it is on, in auto mode, motor is on and program is running'</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%check joint state and can continually check this to see that it has got to the correct position</span>
<span class="comment">% display(strcat('Current Joint State is:',num2str(rob_h.JointState),' and the desired is:', num2str(tempQ)));</span>
</pre><h2>Check if all joints are the same as what we want them to be within 1degree<a name="5"></a></h2><pre class="codeinput"><span class="keyword">if</span> ~isempty(find(round(tempQ-rob_h.JointState), 1))
    <span class="comment">%Set the speed</span>
    rob_h.Type=<span class="string">'SetSpeed'</span>;
    rob_h.Params=[robot_maxreach.move_speed,0];
</pre><h2>Move to an absolute joint reference if there is no path, otherwise<a name="6"></a></h2><pre class="codeinput">    <span class="keyword">if</span> size(all_steps,1)&lt;=1
        rob_h.Type=<span class="string">'MoveJointAbs'</span>;
        <span class="comment">% NOTE THE 6th JOINT IS OVERRIDEN TO 0 EARLIER in NBV so that it is perpendicular to the angle of rotations of joint 5 throughout the scan</span>
        rob_h.Params=tempQ;
        uiwait(msgbox(strcat(<span class="string">'The robot is currently at:'</span>, num2str(rob_h.JointState),<span class="string">' and is planning to move to:'</span>,num2str(rob_h.Params),<span class="string">'. Note 6th Joint may have been changed to 0 if using NBV. Please get ready to push EMERGENCY STOP'</span>)));
        <span class="comment">% Additional Soft motion check - shouldn't be needed</span>
        <span class="keyword">if</span> (rob_h.JointState(2)&lt;-60 || tempQ(2)&lt;-60)
            <span class="keyword">if</span> (rob_h.JointState(2)&lt;-7/3*rob_h.JointState(3)-130 || tempQ(2)&lt;-7/3*tempQ(3)-130)
                uiwait(msgbox(<span class="string">'Note joint 2 is less than -60 hence may be outside motion space; NOT CURRENTLY ALLOWED'</span>));
                rob_h.release;
                error(<span class="string">'Dont use this angle for joint 2'</span>);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        rob_h.Start;
        <span class="comment">% want it to wait until it has finished getting to the next posiiotn before scanning</span>
        rob_h.WaitUntilCompleted(30,0);
        <span class="comment">% simply release the object</span>
        rob_h.release;
</pre><h2>Drive the arm through the sequence of poses in all_steps<a name="7"></a></h2><pre class="codeinput">    <span class="keyword">else</span>
        rob_h.Type=<span class="string">'DriveJointAbs'</span>;
        <span class="keyword">for</span> pathpnt=1:size(all_steps,1)
            current_step_DEG=all_steps(pathpnt,:)*180/pi;
            rob_h.Params=current_step_DEG;
            <span class="comment">%uiwait(msgbox(strcat('The robot is currently at:', num2str(rob_h.JointState),' and is planning to move to:',num2str(rob_h.Params),'. Note 6th Joint may have been changed to 0 if using NBV. Please get ready to push EMERGENCY STOP')));</span>
            <span class="keyword">if</span> current_step_DEG(2)&lt;-60
                <span class="comment">% Additional Soft motion check - shouldn't be needed</span>
                <span class="keyword">if</span> (current_step_DEG(3)&lt;-7/3*current_step_DEG(2)-130)
                    uiwait(msgbox(<span class="string">'Note joint 2 is less than -60 and this could cause a problem with motion space; NOT CURRENTLY ALLOWED'</span>));
                    rob_h.release;
                    error(<span class="string">'Dont use this angle for joint 2 with the angle for joint3'</span>);
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">%display(strcat('step No:',num2str(pathpnt),', Stepping to (in DEG):',num2str(current_step_DEG)));</span>
            rob_h.Start;pause(0.05);

            waitcoutner=0;
            <span class="keyword">while</span> max(abs((rob_h.JointState-current_step_DEG)))&gt;7
                pause(0.15);
                waitcoutner=waitcoutner+1;
                <span class="keyword">if</span> waitcoutner==75 <span class="comment">%about 15 seconds</span>
                    button = questdlg(<span class="string">'Did you press the emergency stop?'</span>,<span class="string">'Running Slow'</span>);
                    <span class="keyword">if</span> strcmp(button,<span class="string">'Yes'</span>)
                        releaserobot(rob_h)
                        error(<span class="string">'emergency stop pressed - exiting'</span>);
                    <span class="keyword">else</span>
                        rob_h.Params=current_step_DEG;
                        rob_h.Start;
                    <span class="keyword">end</span>
                <span class="keyword">elseif</span> waitcoutner&gt;150 <span class="comment">%about 30 seconds we have reissued the command and still no action</span>
                    keyboard
                    releaserobot(rob_h)
                    error(<span class="string">'Problem issuing commands to drive the robot'</span>);
                <span class="keyword">end</span>
                <span class="comment">%display(strcat('Joint state is currently:', num2str(rob_h.JointState)));</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="comment">%% Release movement object</span>
        releaserobot(rob_h)
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>FUNCTION release the robot object<a name="8"></a></h2><pre class="codeinput"><span class="keyword">function</span> releaserobot(rob_h)

    pause(0.1);
    rob_h.Type=<span class="string">'StopDriveJointAbs'</span>;
    rob_h.Start;
    rob_h.WaitUntilCompleted(2,0)
    rob_h.release;
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.4<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
%% use_real_robot_MOVE
%
% *Description:*  This can be called by anywhere and is a way to modulae to
% the moving routine. It starts a robot moving object 
% global Q - joints must be defined
% Note: Lots of magic numbers in this function but most are arbitory pauses
% for coms reasons or for error catching reasons, 
% the other numbers are soft motion checks for the arm but are not
% really needed since specific functions do checks during path planning

%% Function Call
%
% *Inputs:* 
%
% _all_steps_ (many*6 double) radians the steps that the arm must
% move through on its path
%
% *Returns:* NULL

function use_real_robot_MOVE(all_steps)

%% Variables
global Q robot_maxreach
if size(Q,2)~=6
    error('Q - Joints have not been defined properly, should be a global');
end

if nargin==0
    %No path has been passed in
    all_steps=[];
    tempQ=Q*180/pi;   
else
    tempQ=all_steps(end,:)*180/pi;   
end

%% Check that no steps exceed soft limits
if ~joint_softlimit_check(all_steps)
    display('there is a possible bad position in the joint steps, this shouldnt be planned, giving you control')
    keyboard
end
    
%% Setup robot movement object
rob_h=actxserver('EyeInHand.DensoCommand');
%make sure comms up are up to speed
waitcounter=0;
while size(rob_h.JointState,2)~=6
    pause(0.2);
    if waitcounter>25 %5 secs
        error('There is some problem with controller:m , make sure it is on, in auto mode, motor is on and program is running')
    end    
end
%check joint state and can continually check this to see that it has got to the correct position
% display(strcat('Current Joint State is:',num2str(rob_h.JointState),' and the desired is:', num2str(tempQ)));

%% Check if all joints are the same as what we want them to be within 1degree
if ~isempty(find(round(tempQ-rob_h.JointState), 1))
    %Set the speed
    rob_h.Type='SetSpeed';
    rob_h.Params=[robot_maxreach.move_speed,0];

%% Move to an absolute joint reference if there is no path, otherwise
    if size(all_steps,1)<=1
        rob_h.Type='MoveJointAbs';
        % NOTE THE 6th JOINT IS OVERRIDEN TO 0 EARLIER in NBV so that it is perpendicular to the angle of rotations of joint 5 throughout the scan
        rob_h.Params=tempQ;
        uiwait(msgbox(strcat('The robot is currently at:', num2str(rob_h.JointState),' and is planning to move to:',num2str(rob_h.Params),'. Note 6th Joint may have been changed to 0 if using NBV. Please get ready to push EMERGENCY STOP')));
        % Additional Soft motion check - shouldn't be needed
        if (rob_h.JointState(2)<-60 || tempQ(2)<-60)
            if (rob_h.JointState(2)<-7/3*rob_h.JointState(3)-130 || tempQ(2)<-7/3*tempQ(3)-130)
                uiwait(msgbox('Note joint 2 is less than -60 hence may be outside motion space; NOT CURRENTLY ALLOWED'));
                rob_h.release;
                error('Dont use this angle for joint 2');
            end
        end
        rob_h.Start;
        % want it to wait until it has finished getting to the next posiiotn before scanning
        rob_h.WaitUntilCompleted(30,0);
        % simply release the object
        rob_h.release;

%% Drive the arm through the sequence of poses in all_steps
    else
        rob_h.Type='DriveJointAbs';
        for pathpnt=1:size(all_steps,1)
            current_step_DEG=all_steps(pathpnt,:)*180/pi;
            rob_h.Params=current_step_DEG;            
            %uiwait(msgbox(strcat('The robot is currently at:', num2str(rob_h.JointState),' and is planning to move to:',num2str(rob_h.Params),'. Note 6th Joint may have been changed to 0 if using NBV. Please get ready to push EMERGENCY STOP')));
            if current_step_DEG(2)<-60
                % Additional Soft motion check - shouldn't be needed
                if (current_step_DEG(3)<-7/3*current_step_DEG(2)-130)
                    uiwait(msgbox('Note joint 2 is less than -60 and this could cause a problem with motion space; NOT CURRENTLY ALLOWED'));
                    rob_h.release;
                    error('Dont use this angle for joint 2 with the angle for joint3');
                end
            end
            %display(strcat('step No:',num2str(pathpnt),', Stepping to (in DEG):',num2str(current_step_DEG)));
            rob_h.Start;pause(0.05);
            
            waitcoutner=0;
            while max(abs((rob_h.JointState-current_step_DEG)))>7
                pause(0.15);
                waitcoutner=waitcoutner+1;
                if waitcoutner==75 %about 15 seconds                    
                    button = questdlg('Did you press the emergency stop?','Running Slow');
                    if strcmp(button,'Yes')
                        releaserobot(rob_h)
                        error('emergency stop pressed - exiting');                    
                    else
                        rob_h.Params=current_step_DEG;
                        rob_h.Start;
                    end
                elseif waitcoutner>150 %about 30 seconds we have reissued the command and still no action
                    keyboard
                    releaserobot(rob_h)
                    error('Problem issuing commands to drive the robot');                    
                end
                %display(strcat('Joint state is currently:', num2str(rob_h.JointState)));                
            end
        end
        %% Release movement object
        releaserobot(rob_h)
    end    
end

%% FUNCTION release the robot object
function releaserobot(rob_h)

    pause(0.1);
    rob_h.Type='StopDriveJointAbs';
    rob_h.Start;
    rob_h.WaitUntilCompleted(2,0)
    rob_h.release;

##### SOURCE END #####
-->
   </body>
</html>