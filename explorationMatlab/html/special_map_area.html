
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns:mwsh="http://www.mathworks.com/namespace/mcode/v1/syntaxhighlight.dtd">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   
      <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      -->
      <title>special_map_area</title>
      <meta name="generator" content="MATLAB 7.4">
      <meta name="date" content="2008-01-14">
      <meta name="m-file" content="special_map_area"><style>

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head>
   <body>
      <div class="content"><pre class="codeinput"><span class="keyword">function</span> special_map_area()

<span class="keyword">global</span> RangeData PointData workspace

<span class="comment">% load ScanforClassifier-0to-60</span>
<span class="comment">% workspace.spec_pnts=[];</span>

[zeroRangeCol,zeroRangeRow]=find(RangeData&lt;20);

<span class="comment">%diff te pan direction</span>
diffval=diff(RangeData,1,2);

[diffCol,diffRow]=find(diffval&gt;workspace.inc_size*1000);

<span class="comment">% Check that it is not a spike caused by a zero value eg +150 then -150 so</span>
<span class="comment">% check the sum over several values</span>
<span class="comment">% This also makes sure we don't included specled (varying quickly without</span>
<span class="comment">% any value about shadowing)</span>
Istokeep=[];
<span class="keyword">for</span> i=1:size(diffCol,1)
    <span class="keyword">if</span> size(diffval,2)&gt;(diffRow(i)+5)
        <span class="keyword">if</span> abs(sum(diffval(diffCol(i),diffRow(i):diffRow(i)+5)))&gt;workspace.inc_size*1000
            Istokeep=[Istokeep,i];
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        <span class="keyword">if</span> abs(sum(diffval(diffCol(i),diffRow(i):end)))&gt;workspace.inc_size*1000
            Istokeep=[Istokeep,i];
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

diffCol=diffCol(Istokeep);
diffRow=diffRow(Istokeep);


<span class="comment">%special points are the diffCol,diffRow-&gt;diffRow+1 values where neither is</span>
<span class="comment">%a zero return (these are ignored in this section since it is too hard to</span>
<span class="comment">%calculate the areas of interest</span>
ALLspec_pnts_ind=[];
<span class="keyword">for</span> i=1:2:size(diffCol,1)
    <span class="comment">%check if either point is from a zero range point</span>
    <span class="keyword">if</span> isempty(find(diffCol(i)==zeroRangeCol &amp; zeroRangeRow==diffRow(i),1)) &amp;&amp;<span class="keyword">...</span>
            isempty(find(diffCol(i)==zeroRangeCol &amp; zeroRangeRow==diffRow(i)+1,1))

        radius=sqrt(sum(((PointData(diffCol(i),diffRow(i),:)-PointData(diffCol(i),diffRow(i)+1,:))/2).^2));
        <span class="comment">%make sure the radius is not too large</span>
        <span class="keyword">if</span> radius&gt;2*workspace.inc_size; radius=2*workspace.inc_size; <span class="keyword">end</span>

        <span class="comment">%Determine the mid point between the points with the big</span>
        <span class="comment">%differential</span>
        special_point=squeeze((PointData(diffCol(i),diffRow(i),:)+PointData(diffCol(i),diffRow(i)+1,:))/2)';
        [nothing,level2]=GetImpLevInfo(special_point);
        <span class="keyword">if</span> size(level2,1)&gt;0 <span class="comment">%then we know its inside level 2 at least so go on</span>
<span class="comment">%         workspace.spec_pnts=[workspace.spec_pnts;...</span>
<span class="comment">%           workspace.unknowncoords(workspace.lev2unknown(...</span>
<span class="comment">%           sqrt((workspace.unknowncoords(workspace.lev2unknown,1)-special_point(1)).^2+...</span>
<span class="comment">%                (workspace.unknowncoords(workspace.lev2unknown,2)-special_point(2)).^2+...</span>
<span class="comment">%                (workspace.unknowncoords(workspace.lev2unknown,3)-special_point(3)).^2)&lt;radius),:)];</span>
<span class="comment">%         workspace.spec_pnts=unique(workspace.spec_pnts,'rows');</span>
<span class="comment">%get the index, then use all surrounding 27 cubes</span>
            spec_pnt_ind=round(special_point/workspace.inc_size);
            ALLspec_pnts_ind=[ALLspec_pnts_ind;<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2)-1,spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2)-1,spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2)-1,spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2),spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2),spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2),spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2)+1,spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2)+1,spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1)-1,spec_pnt_ind(2)+1,spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2)-1,spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2)-1,spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2)-1,spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2),spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2),spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2),spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2)+1,spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2)+1,spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1),spec_pnt_ind(2)+1,spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2)-1,spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2)-1,spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2)-1,spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2),spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2),spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2),spec_pnt_ind(3)+1;<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2)+1,spec_pnt_ind(3)-1;<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2)+1,spec_pnt_ind(3);<span class="keyword">...</span>
            spec_pnt_ind(1)+1,spec_pnt_ind(2)+1,spec_pnt_ind(3)+1];

        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">%make it not an index anymore by real points</span>
workspace.spec_pnts=unique([ALLspec_pnts_ind*workspace.inc_size;workspace.spec_pnts],<span class="string">'rows'</span>);

<span class="comment">%normalise to the workspace size</span>
workspace.spec_pnts=round(workspace.spec_pnts/workspace.inc_size)*workspace.inc_size;
workspace.spec_pnts=setdiff(workspace.spec_pnts,[workspace.knowncoords;workspace.indexedobsticles],<span class="string">'rows'</span>);

<span class="comment">% plot3(workspace.spec_pnts(:,1),workspace.spec_pnts(:,2),workspace.spec_pnts(:,3),'k*');</span>
<span class="comment">% hold on;</span>
<span class="comment">% plot3(PointData(:,:,1),PointData(:,:,2),PointData(:,:,3),'g.')</span>
</pre><p class="footer"><br>
            Published with MATLAB&reg; 7.4<br></p>
      </div>
      <!--
##### SOURCE BEGIN #####
function special_map_area()

global RangeData PointData workspace

% load ScanforClassifier-0to-60
% workspace.spec_pnts=[];

[zeroRangeCol,zeroRangeRow]=find(RangeData<20);

%diff te pan direction
diffval=diff(RangeData,1,2);

[diffCol,diffRow]=find(diffval>workspace.inc_size*1000);

% Check that it is not a spike caused by a zero value eg +150 then -150 so
% check the sum over several values
% This also makes sure we don't included specled (varying quickly without
% any value about shadowing)
Istokeep=[];
for i=1:size(diffCol,1)
    if size(diffval,2)>(diffRow(i)+5)
        if abs(sum(diffval(diffCol(i),diffRow(i):diffRow(i)+5)))>workspace.inc_size*1000
            Istokeep=[Istokeep,i];
        end
    else
        if abs(sum(diffval(diffCol(i),diffRow(i):end)))>workspace.inc_size*1000
            Istokeep=[Istokeep,i];
        end    
    end
end

diffCol=diffCol(Istokeep);
diffRow=diffRow(Istokeep);


%special points are the diffCol,diffRow->diffRow+1 values where neither is
%a zero return (these are ignored in this section since it is too hard to
%calculate the areas of interest
ALLspec_pnts_ind=[];
for i=1:2:size(diffCol,1)
    %check if either point is from a zero range point
    if isempty(find(diffCol(i)==zeroRangeCol & zeroRangeRow==diffRow(i),1)) &&...
            isempty(find(diffCol(i)==zeroRangeCol & zeroRangeRow==diffRow(i)+1,1))
        
        radius=sqrt(sum(((PointData(diffCol(i),diffRow(i),:)-PointData(diffCol(i),diffRow(i)+1,:))/2).^2));
        %make sure the radius is not too large
        if radius>2*workspace.inc_size; radius=2*workspace.inc_size; end

        %Determine the mid point between the points with the big
        %differential
        special_point=squeeze((PointData(diffCol(i),diffRow(i),:)+PointData(diffCol(i),diffRow(i)+1,:))/2)';
        [nothing,level2]=GetImpLevInfo(special_point);
        if size(level2,1)>0 %then we know its inside level 2 at least so go on
%         workspace.spec_pnts=[workspace.spec_pnts;...
%           workspace.unknowncoords(workspace.lev2unknown(...
%           sqrt((workspace.unknowncoords(workspace.lev2unknown,1)-special_point(1)).^2+...
%                (workspace.unknowncoords(workspace.lev2unknown,2)-special_point(2)).^2+...
%                (workspace.unknowncoords(workspace.lev2unknown,3)-special_point(3)).^2)<radius),:)];   
%         workspace.spec_pnts=unique(workspace.spec_pnts,'rows');
%get the index, then use all surrounding 27 cubes
            spec_pnt_ind=round(special_point/workspace.inc_size);
            ALLspec_pnts_ind=[ALLspec_pnts_ind;...
            spec_pnt_ind(1)-1,spec_pnt_ind(2)-1,spec_pnt_ind(3)-1;...
            spec_pnt_ind(1)-1,spec_pnt_ind(2)-1,spec_pnt_ind(3);...
            spec_pnt_ind(1)-1,spec_pnt_ind(2)-1,spec_pnt_ind(3)+1;...
            spec_pnt_ind(1)-1,spec_pnt_ind(2),spec_pnt_ind(3)-1;...
            spec_pnt_ind(1)-1,spec_pnt_ind(2),spec_pnt_ind(3);...
            spec_pnt_ind(1)-1,spec_pnt_ind(2),spec_pnt_ind(3)+1;...
            spec_pnt_ind(1)-1,spec_pnt_ind(2)+1,spec_pnt_ind(3)-1;...
            spec_pnt_ind(1)-1,spec_pnt_ind(2)+1,spec_pnt_ind(3);...
            spec_pnt_ind(1)-1,spec_pnt_ind(2)+1,spec_pnt_ind(3)+1;...
            spec_pnt_ind(1),spec_pnt_ind(2)-1,spec_pnt_ind(3)-1;...
            spec_pnt_ind(1),spec_pnt_ind(2)-1,spec_pnt_ind(3);...
            spec_pnt_ind(1),spec_pnt_ind(2)-1,spec_pnt_ind(3)+1;...
            spec_pnt_ind(1),spec_pnt_ind(2),spec_pnt_ind(3)-1;...
            spec_pnt_ind(1),spec_pnt_ind(2),spec_pnt_ind(3);...
            spec_pnt_ind(1),spec_pnt_ind(2),spec_pnt_ind(3)+1;...
            spec_pnt_ind(1),spec_pnt_ind(2)+1,spec_pnt_ind(3)-1;...
            spec_pnt_ind(1),spec_pnt_ind(2)+1,spec_pnt_ind(3);...
            spec_pnt_ind(1),spec_pnt_ind(2)+1,spec_pnt_ind(3)+1;...
            spec_pnt_ind(1)+1,spec_pnt_ind(2)-1,spec_pnt_ind(3)-1;...
            spec_pnt_ind(1)+1,spec_pnt_ind(2)-1,spec_pnt_ind(3);...
            spec_pnt_ind(1)+1,spec_pnt_ind(2)-1,spec_pnt_ind(3)+1;...
            spec_pnt_ind(1)+1,spec_pnt_ind(2),spec_pnt_ind(3)-1;...
            spec_pnt_ind(1)+1,spec_pnt_ind(2),spec_pnt_ind(3);...
            spec_pnt_ind(1)+1,spec_pnt_ind(2),spec_pnt_ind(3)+1;...
            spec_pnt_ind(1)+1,spec_pnt_ind(2)+1,spec_pnt_ind(3)-1;...
            spec_pnt_ind(1)+1,spec_pnt_ind(2)+1,spec_pnt_ind(3);...
            spec_pnt_ind(1)+1,spec_pnt_ind(2)+1,spec_pnt_ind(3)+1];
        
        end
    end
end

%make it not an index anymore by real points
workspace.spec_pnts=unique([ALLspec_pnts_ind*workspace.inc_size;workspace.spec_pnts],'rows');

%normalise to the workspace size
workspace.spec_pnts=round(workspace.spec_pnts/workspace.inc_size)*workspace.inc_size;
workspace.spec_pnts=setdiff(workspace.spec_pnts,[workspace.knowncoords;workspace.indexedobsticles],'rows');

% plot3(workspace.spec_pnts(:,1),workspace.spec_pnts(:,2),workspace.spec_pnts(:,3),'k*');
% hold on;
% plot3(PointData(:,:,1),PointData(:,:,2),PointData(:,:,3),'g.')
##### SOURCE END #####
-->
   </body>
</html>